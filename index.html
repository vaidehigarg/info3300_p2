<!DOCTYPE html>
<html>
<head>
<meta name="authors" content="Vaidehi Garg, Brendan Fox, and Jason Kwon">
<title>INFO 3300: Project 2</title>
<link href="https://fonts.googleapis.com/css?family=Gaegu" rel="stylesheet">
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

<style>
body { background-color: rgb(250,205,40); font-family: 'Gaegu', sans-serif; font-size: 32px; }
section { width: 100%; }
h2 { margin: -30px; }
svg { border: solid #000000 1px; margin: 10px 10px 10px 10px;}
#introduction { text-transform: uppercase; letter-spacing: 0.1em; font-weight: bold; }

/* Slider created with guidance from https://www.w3schools.com/howto/howto_js_rangeslider.asp */
.slidecontainer {
    width: 50%; /* Width of the outside container */
}

/* The slider itself */
.slider {
    -webkit-appearance: none;  /* Override default CSS styles */
    appearance: none;
    width: 100%; /* Full-width */
    height: 25px; /* Specified height */
    background: rgb(2,10,13); /* Background color */
    outline: none; /* Remove outline */
    opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
    -webkit-transition: .2s; 0.2 seconds transition on hover */
    transition: opacity .2s;*/
}

/* Mouse-over effects */
.slider:hover {
    opacity: 1;
}

/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */
.slider::-webkit-slider-thumb {
    -webkit-appearance: none; /* Override default look */
    appearance: none;
    width: 50px; /* Set a specific slider handle width */
    height: 50px; /* Slider handle height */
    border: 0;
    background: url('donut.png');
    cursor: pointer; /* Cursor on hover */
}

.slider::-moz-range-thumb {
    width: 50px; /* Set a specific slider handle width */
    height: 50px; /* Slider handle height */
    border: 0;
    background: url('donut.png');
    cursor: pointer; /* Cursor on hover */
}
</style>
</head>

<body>

<!-- HEADER -->
<section id="introduction">
  <div id="header" align="center">
    <h5>INFO 3300: Project 2</h6>
    <h2>The Simpsons Through The Ages</h3>
    <h5>Vaidehi Garg, Brendan Fox, Jason Kwon</h3>
  </div>
</section>
<!-- END HEADER -->

<!-- VISUALIZATION 1-->
<!-- IMDB ratings and viewership (in millions) vs. episode # (slider controls seasons) -->
<section id="viz1_section">
  <div id="viz1_div" align="center">
    <svg id="season-graph" width="800" height="440"></svg>

    <div class="slidecontainer">
      <input type="range" min="1" max="28" value="1" class="slider" id="season-slider">
    </div>

    <script>
    var svg = d3.select("#season-graph");

    var width = 800;
    var height = 440;
    var padding = 50;

    var seasonSlider = document.getElementById("season-slider");

    /* season variable, controlled by slider */
    var season = 1;

    /* import data */
    d3.queue()
    .defer(d3.csv, "mod-data/simpsons_episodes.csv", parseRow)
    .await(callback);

    var parseRow = function (row) {
      return row;
    }

    ratings = [];
    viewership = [];
    episodes = [];

    function callback (error, data) {

      if (error) { console.log(error); }
  //    console.log(data);

      for (var i=0; i<28; i++) {
        ratings.push([]);
        viewership.push([]);
        episodes.push([]);
    //    console.log(episodes);
      }

      data.forEach(function(d, i) {
        season_num = d.season;
        ratings[season_num-1].push(Number(d.imdb_rating));
        viewership[season_num-1].push(Number(d.us_viewers_in_millions));
        episodes[season_num-1].push(Number(d.number_in_season));
      });

    //  console.log(ratings);
    //  console.log(viewership);
    //  console.log(episodes);

      /* default display for season = 1 */
      svg.append("text")
        .attr("id", "season-number")
        .attr("x", "50%")
        .attr("y", "10%")
        .attr("text-anchor", "middle")
        .text("Episode Viewership and Rating: Season " + String(season));

      var xScale = d3.scaleLinear()
      .domain(d3.extent(episodes[season-1]))
      .range([padding,width-padding]);

      var yRatingScale = d3.scaleLinear()
      .domain(d3.extent(ratings[season-1]))
      .range([height-padding,padding]);

      var yViewsScale = d3.scaleLinear()
      .domain(d3.extent(viewership[season-1]))
      .range([height-padding,padding]);

      var xScale = svg.append("g").call(d3.axisBottom(xScale))
      .attr("transform", "translate(" + 0 + "," + (height-padding) + ")");

      var yRatingAxis = svg.append("g").call(d3.axisLeft(yRatingScale))
      .attr("transform", "translate(" + padding + "," + 0 + ")");

      var yViewsAxis = svg.append("g").call(d3.axisRight(yViewsScale))
      .attr("transform", "translate(" + (width-padding) + "," + 0 + ")");

      seasonSlider.oninput = function () {
        season = Number(seasonSlider.value);
        redraw(season);
      };
    }

    function redraw(season) {
      svg.select("#season-number")
      .text("Episode Viewership and Rating: Season " + String(season));
    }

    </script>
</section>

<!-- VISUALIZATION 2-->
<!-- Episode analysis -->
<section id="episode">
  <div align="center">
    <svg id = "episode-analysis" width = "900" height = "400">

    </svg>
  </div>
  <script>

  var episodes;
  var lines = new Array(27);
  for(var i = 0; i < lines.length; i++){
      lines[i] = [];
  }

  var characters = new Array(27);
  for(var i = 0; i < characters.length; i++){
      characters[i] = [];
  }

  var locations = new Array(27);
  for(var i = 0; i < locations.length; i++){
      locations[i] = [];
  }



  d3.queue()
  .defer(d3.csv, "mod-data/simpsons_episodes.csv", parseRow)
  .awaitAll(v2callback); //fetch 27 episodes


  d3.queue()
  .defer(d3.csv, "mod-data/simpsons_script_lines.csv", parseRow)
  .awaitAll(linesCallback); //get the lines, need these for data on characters/locations

  d3.queue()
  .defer(d3.csv, "mod-data/simpsons_characters.csv", parseRow)
  .awaitAll(charactersCallback);

  d3.queue()
  .defer(d3.csv, "mod-data/simpsons_locations.csv", parseRow)
  .awaitAll(locationsCallback);



  function v2callback(error, data){
    if (error) { console.log(error); }
    var topEpisodes = [];
    var seasonBuffer = [];
    var svg = d3.select("#episode-analysis");
    data.forEach(function(row){//this works because the data is sorted by season, ie each season comes in a block
      if(seasonBuffer.length == 0){ //makes sure there is always an episode to look at
        seasonBuffer.push(row);
        return;
      }
      //console.log(topEpisodes.length);
    //  console.log(row['season']);
      //console.log(seasonBuffer[0]['season']);
      if(row['season'] != seasonBuffer[0]['season']){ //if the current episode is a new season, find most watched episode and push it
        seasonBuffer.sort(function(a,b){return b['us_viewers_in_millions'] - a['us_viewers_in_millions']});
        topEpisodes.push(seasonBuffer[0]);
        seasonBuffer.length = 0;

      }
      else{
        seasonBuffer.push(row);

      }

    });
    episodes = topEpisodes;
    /*topEpisodes.forEach(function(element){ //primarily for test purposes
      svg.append("text")
        .attr("id", "season-")
        .attr("x", "50%")
        .attr("y", "10%")
        .attr("text-anchor", "middle")
        .text("" + element['title']);
        console.log(element['title']);
    })*/
  }

  function linesCallback(error, data){
    data.forEach(function(row){
      episodes.forEach(function(episode, index){
        if(row['episode_id'] == episode['id']){
          lines[episode['season']].push(row); //get every line assigned to its episode separating them by season
        }
      });
    });
      console.log(lines);
  }

  function charactersCallback(error, data){
    //console.log(lines);
    data.forEach(function(row){
      lines.forEach(function(episode, index){//lines is an array of arrays, each of which represents one episode
    //    console.log(episode);
        episode.forEach(function(line){
        //  console.log(line);
          if(row['id']==line['character_id']){
            characters[episode['season']].push(row);
          }
        //  console.log("a");
        });
      });
    });
  //  console.log(characters);
  }

  function locationsCallback(error, data){
    data.forEach(function(row){
      lines.forEach(function(episode, index){
        episode.forEach(function(line){
          if(row['id'] == line['location_id']){
            locations[episode['season']].push(row);
          }

        });
      });
    });
    //console.log(locations);
  }
  </script>
</section>

</body>
</html>
